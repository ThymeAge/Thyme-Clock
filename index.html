<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ThymeAge v2.2 Â· Cardio Longevity Age</title>
<meta name="description" content="ThymeAge v2.2: Calculadora de Edad-Salud (CORE y Extendido) con nÃºcleo gelatina, halo dinÃ¡mico y mÃ³dulos de SueÃ±o, EstrÃ©s, AerÃ³bico, Fuerza y NutriciÃ³n MediterrÃ¡nea.">
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ«§</text></svg>">
<style>
  :root{
    --bg:#0a0c12; --panel:#0f1422; --ink:#e9efff; --muted:#9aa4c4; --grid:#1a2035;
    --accent:#62ffd0; --accent2:#6ae3ff; --good:#6affad; --warn:#ffd66b; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(60% 80% at 50% 10%, #0f1730, #090c16);color:var(--ink);
       font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.6;font-size:16px}
  header{position:sticky;top:0;z-index:10;background:rgba(10,12,18,.72);backdrop-filter:blur(10px);border-bottom:1px solid var(--grid)}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;gap:12px;align-items:center}
  .brand{font-weight:900;letter-spacing:.3px}
  .brand .big{font-size:22px;color:var(--accent)}
  .brand .by{display:block;color:var(--muted);font-size:12px;margin-top:2px}
  main{max-width:1200px;margin:0 auto;padding:18px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
  .card{background:linear-gradient(180deg,#10162a,#0b1020);border:1px solid var(--grid);
        border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
  .col-12{grid-column:span 12}.col-8{grid-column:span 8}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
  h2{margin:0 0 10px 0;font-size:20px}
  h3{margin:10px 0 6px 0;font-size:15px;color:var(--muted)}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input, select{width:100%;padding:12px;border-radius:12px;background:#0c1120;border:1px solid #1e2742;color:var(--ink);outline:none;font-size:16px}
  input:focus, select:focus{border-color:#2e3c6e}
  .btn{background:linear-gradient(180deg,#1b8eff,#1279ff);border:none;color:#fff;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:800;font-size:15px}
  .btn.ghost{background:#10162b;border:1px solid #263259;color:var(--ink)}
  .stack{display:flex;gap:12px;flex-wrap:wrap}
  .kpi .label{color:var(--muted);font-size:13px;margin-bottom:6px}
  .kpi .val{font-size:30px;font-weight:900}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .right{text-align:right}
  progress{width:100%;height:12px;border:none;border-radius:7px;background:#131b34}
  progress::-webkit-progress-bar{background:#131b34;border-radius:7px}
  progress::-webkit-progress-value{background:linear-gradient(90deg,var(--accent),var(--good));border-radius:7px}
  .muted{color:var(--muted);font-size:13px}
  .pill{display:inline-block;border:1px solid #273056;background:#0d142b;padding:7px 11px;border-radius:999px;color:var(--muted);font-size:12px}
  footer{max-width:1200px;margin:24px auto 44px auto;padding:0 18px;color:var(--muted);font-size:12px;text-align:center;border-top:1px solid #1a2035;padding-top:12px}

  /* === GELATIN BUBBLE v2.2 === */
  .bubble-wrap{position:relative;display:flex;align-items:center;gap:18px}
  .bubble-area{position:relative;width:180px;height:180px;display:grid;place-items:center}
  .halo{position:absolute;width:160px;height:160px;border-radius:50%;filter:blur(16px);opacity:.65;animation:pulse 3s ease-in-out infinite}
  .halo.good{background:radial-gradient(60% 60% at 50% 50%, rgba(90,255,170,.55), rgba(60,200,150,.10)); box-shadow:0 0 40px rgba(90,255,170,.35)}
  .halo.warn{background:radial-gradient(60% 60% at 50% 50%, rgba(255,210,120,.55), rgba(255,180,80,.10)); box-shadow:0 0 40px rgba(255,210,120,.35)}
  .halo.bad{ background:radial-gradient(60% 60% at 50% 50%, rgba(255,120,120,.55), rgba(255,80,80,.10));  box-shadow:0 0 40px rgba(255,120,120,.35)}
  .bubble{width:160px;height:160px;border-radius:50%;
          background:radial-gradient(60% 60% at 40% 35%, rgba(160,255,210,.55), rgba(100,200,255,.18));
          position:relative;filter:url(#goo);
          box-shadow:0 0 50px rgba(100,200,255,.25) inset, 0 0 40px rgba(100,200,255,.15);
          animation:breath 3s ease-in-out infinite}
  .bubble:after,.bubble:before{content:"";position:absolute;border-radius:50%;
          background:radial-gradient(60% 60% at 40% 35%, rgba(255,255,255,.55), rgba(255,255,255,0));}
  .bubble:after{width:50px;height:50px;left:22px;top:26px;opacity:.6}
  .bubble:before{width:28px;height:28px;left:76px;top:16px;opacity:.4}
  @keyframes breath{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
  @keyframes pulse{0%{transform:scale(0.95);opacity:.55}50%{transform:scale(1.08);opacity:.8}100%{transform:scale(0.95);opacity:.55}}
  .bubble.good{background:radial-gradient(60% 60% at 40% 35%, rgba(90,255,170,.55), rgba(60,200,150,.15));}
  .bubble.warn{background:radial-gradient(60% 60% at 40% 35%, rgba(255,210,120,.55), rgba(255,180,80,.15));}
  .bubble.bad{ background:radial-gradient(60% 60% at 40% 35%, rgba(255,120,120,.55), rgba(255,80,80,.15));}
  .bubble-number{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:900;color:#fff;text-shadow:0 2px 12px rgba(0,0,0,.45)}
  .bubble-caption{font-size:13px;color:var(--muted)}
  svg#filters{position:absolute;width:0;height:0}
  .sound-toggle{display:flex;gap:8px;align-items:center;margin-top:8px;font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<svg id="filters" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <filter id="goo">
      <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur"/>
      <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 22 -10" result="goo"/>
      <feBlend in="SourceGraphic" in2="goo"/>
    </filter>
  </defs>
</svg>

<header>
  <div class="wrap">
    <div class="brand">
      <span class="big">ThymeAge v2.2 â€” Cardio Longevity Age</span>
      <span class="by">by Dra. Antonela Costa Varsi</span>
    </div>
    <div style="flex:1"></div>
    <button class="btn" onclick="computeAll()">Calcular</button>
    <button class="btn ghost" onclick="saveJSON()">Guardar</button>
    <button class="btn ghost" onclick="loadJSON()">Cargar</button>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card col-8">
      <h2>Datos bÃ¡sicos</h2>
      <div class="stack">
        <div style="flex:1 1 160px;min-width:160px">
          <label>Sexo</label>
          <select id="sex"><option value="female">Femenino</option><option value="male">Masculino</option></select>
        </div>
        <div style="flex:1 1 140px;min-width:140px">
          <label>Edad cronolÃ³gica (aÃ±os)</label>
          <input id="age" type="number" min="10" max="100" step="1" value="39">
        </div>
        <div style="flex:2 1 260px;min-width:260px">
          <label class="muted">Consejo</label>
          <div class="pill">Usa tus Ãºltimos resultados de laboratorio y presiÃ³n.</div>
        </div>
      </div>
    </section>

    <section class="card col-4">
      <h2>Resultado</h2>
      <div class="bubble-wrap">
        <div class="bubble-area">
          <div id="halo" class="halo good"></div>
          <div id="bubble" class="bubble good"><div id="bubbleNumber" class="bubble-number">â€“</div></div>
        </div>
        <div>
          <div class="kpi"><div class="label">Edad-Salud EXTENDIDA</div><div class="val" id="age_ext">â€“</div><div class="muted" id="age_ext_ci"></div></div>
          <div class="kpi" style="margin-top:8px"><div class="label">Edad-Salud CORE</div><div class="val" id="age_core">â€“</div><div class="muted" id="age_core_ci"></div></div>
          <div class="two" style="margin-top:8px">
            <div><div class="muted">Î” CORE</div><div id="delta_core">â€“</div></div>
            <div class="right"><div class="muted">+ MÃ³dulos</div><div id="delta_modules">â€“</div></div>
          </div>
          <div class="bubble-caption" id="bubbleCaption">Estado Ã³ptimo</div>
          <label class="sound-toggle"><input id="soundOn" type="checkbox"> Activar sonido cuando el resultado es Ã³ptimo</label>
        </div>
      </div>
    </section>

    <section class="card col-6">
      <h2>CORE Â· Variables clÃ­nicas</h2>
      <div class="two">
        <div>
          <h3>CardiometabÃ³lico</h3>
          <label>PAS media (mmHg)</label><input id="SBP" type="number" step="1" placeholder="120">
          <label>ApoB (mg/dL)</label><input id="ApoB" type="number" step="1" placeholder="">
          <label>no-HDL (mg/dL) â€”usar si no hay ApoB</label><input id="nonHDL" type="number" step="1" placeholder="130">
          <label>HbA1c (%)</label><input id="A1c" type="number" step="0.1" placeholder="5.3">
          <label>Glucosa ayunas (mg/dL)</label><input id="FPG" type="number" step="1" placeholder="90">
          <label>eGFR (ml/min/1.73mÂ²)</label><input id="eGFR" type="number" step="1" placeholder="100">
          <label>hs-CRP (mg/L)</label><input id="CRP" type="number" step="0.1" placeholder="">
        </div>
        <div>
          <h3>AntropometrÃ­a & Fitness</h3>
          <label>Cintura (cm)</label><input id="waist" type="number" step="0.1" placeholder="72">
          <label>Altura (cm)</label><input id="height" type="number" step="0.1" placeholder="165">
          <label>FC reposo (lpm)</label><input id="RHR" type="number" step="1" placeholder="64">
          <label>VOâ‚‚max (ml/kg/min)</label><input id="VO2" type="number" step="0.1" placeholder="36">
          <label>Fuerza prensiÃ³n (kg)</label><input id="grip" type="number" step="0.1" placeholder="28">
          <label>Tabaquismo</label>
          <select id="smoke"><option value="never">Nunca</option><option value="former">Exfumadora</option><option value="current">Actual</option></select>
        </div>
      </div>
    </section>

    <section class="card col-6">
      <h2>EXTENDIDO Â· SueÃ±o, EstrÃ©s, Actividad & NutriciÃ³n</h2>
      <div class="three">
        <div>
          <h3>SueÃ±o</h3>
          <label>Tiempo sueÃ±o (h, media 7â€“14 dÃ­as)</label><input id="TST" type="number" step="0.1" placeholder="7.0">
          <label>Eficiencia de sueÃ±o (%)</label><input id="SE" type="number" step="1" placeholder="88">
          <label>AHI (si estudio)</label><input id="AHI" type="number" step="1" placeholder="">
          <label>ODI (si estudio)</label><input id="ODI" type="number" step="1" placeholder="">
          <label>STOP-BANG alto</label><select id="STOP"><option value="no">No</option><option value="si">SÃ­</option></select>
        </div>
        <div>
          <h3>EstrÃ©s / Mental</h3>
          <label>PSS-10 (0â€“40)</label><input id="PSS" type="number" step="1" placeholder="14">
          <label>PHQ-9 (0â€“27)</label><input id="PHQ" type="number" step="1" placeholder="3">
          <label>GAD-7 (0â€“21)</label><input id="GAD" type="number" step="1" placeholder="3">
          <h3>Actividad</h3>
          <label>AerÃ³bico Â· MVPA (min/sem)</label><input id="MVPA" type="number" step="10" placeholder="150">
          <label>Fuerza Â· dÃ­as/sem</label><input id="STR" type="number" step="1" placeholder="2">
        </div>
        <div>
          <h3>NutriciÃ³n</h3>
          <label>Adherencia Dieta MediterrÃ¡nea (0â€“14)</label><input id="MedDiet" type="number" step="1" min="0" max="14" placeholder="7">
          <label>Ultraprocesados (veces/sem)</label><input id="Ultra" type="number" step="1" min="0" placeholder="">
          <label>Alcohol (unidades/sem)</label><input id="AlcoholU" type="number" step="1" min="0" placeholder="">
        </div>
      </div>
    </section>

    <section class="card col-12">
      <h2>Desglose por dominios</h2>
      <div class="grid">
        <div class="col-2"><div class="muted">CardiometabÃ³lico</div><progress id="prog_cardiomet" max="1" value="0"></progress><div class="muted" id="txt_cardiomet">â€“</div></div>
        <div class="col-2"><div class="muted">Fitness / VOâ‚‚ & Grip</div><progress id="prog_fitness" max="1" value="0"></progress><div class="muted" id="txt_fitness">â€“</div></div>
        <div class="col-2"><div class="muted">AntropometrÃ­a</div><progress id="prog_anthro" max="1" value="0"></progress><div class="muted" id="txt_anthro">â€“</div></div>
        <div class="col-2"><div class="muted">Tabaquismo</div><progress id="prog_smoke" max="1" value="0"></progress><div class="muted" id="txt_smoke">â€“</div></div>
        <div class="col-2"><div class="muted">SueÃ±o</div><progress id="prog_sleep" max="1" value="0"></progress><div class="muted" id="txt_sleep">â€“</div></div>
        <div class="col-2"><div class="muted">EstrÃ©s / Mental</div><progress id="prog_stress" max="1" value="0"></progress><div class="muted" id="txt_stress">â€“</div></div>
      </div>
      <div class="grid" style="margin-top:10px">
        <div class="col-3"><div class="muted">Actividad AerÃ³bica</div><progress id="prog_aero" max="1" value="0"></progress><div class="muted" id="txt_aero">â€“</div></div>
        <div class="col-3"><div class="muted">Entrenamiento de Fuerza</div><progress id="prog_strength" max="1" value="0"></progress><div class="muted" id="txt_strength">â€“</div></div>
        <div class="col-3"><div class="muted">NutriciÃ³n / MediterrÃ¡nea</div><progress id="prog_diet" max="1" value="0"></progress><div class="muted" id="txt_diet">â€“</div></div>
        <div class="col-3"><div class="muted">Notas</div><div class="muted">Cada mÃ³dulo extendido tiene tope Â±1 aÃ±o para controlar ruido.</div></div>
      </div>
    </section>
  </div>
</main>

<footer>
  Â© 2025 ThymeAge Â· Created by Dra. Antonela Costa Varsi
</footer>

<script>
function val(id){ const el=document.getElementById(id); return el ? el.value : ""; }
function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }
function has(v){ return v!==null && v!=="" && !isNaN(parseFloat(v)); }
function n(v){ return parseFloat(v); }

function norms(sex){
  const t={female:{SBP_m:120,SBP_s:15,ApoB_m:100,ApoB_s:30,nHDL_m:130,nHDL_s:30,A1c_m:5.3,A1c_s:0.4,FPG_m:90,FPG_s:10,eGFR_m:100,eGFR_s:15,CRP_m:1.5,CRP_s:1.5,WHtR_m:0.50,WHtR_s:0.06,RHR_m:70,RHR_s:10,VO2_m:35,VO2_s:7,Grip_m:28,Grip_s:6},
           male:{SBP_m:120,SBP_s:15,ApoB_m:100,ApoB_s:30,nHDL_m:130,nHDL_s:30,A1c_m:5.3,A1c_s:0.4,FPG_m:90,FPG_s:10,eGFR_m:100,eGFR_s:15,CRP_m:1.5,CRP_s:1.5,WHtR_m:0.50,WHtR_s:0.06,RHR_m:68,RHR_s:10,VO2_m:42,VO2_s:7,Grip_m:44,Grip_s:8}};
  return t[sex];
}
function weights(){ return {cardiomet:0.50, fitness:0.25, anthro:0.15, smoke:0.10, sleep:0.06, stress:0.06, aero:0.05, strength:0.05, diet:0.08}; }
function scalars(){ return {k:2.5, cap_z:2.5, cap_sleep:1.0, cap_stress:1.0, cap_aero:1.0, cap_strength:1.0, cap_diet:1.0, unc_core:2.5, unc_ext:0.8}; }

function z_worse(v, m, s, cap){ if(!has(v)) return null; return clamp((n(v)-m)/s, -cap, cap); }
function z_better(v, m, s, cap){ if(!has(v)) return null; return clamp(-(n(v)-m)/s, -cap, cap); }
function avg(arr){ const v=arr.filter(x=>x!==null && !isNaN(x)); return v.length? v.reduce((a,b)=>a+b,0)/v.length : null; }

function computeAll(){
  const sex = val("sex"); const age = has(val("age"))? n(val("age")) : 40;
  const N = norms(sex); const W = weights(); const S = scalars();

  const z_SBP = z_worse(val("SBP"), N.SBP_m, N.SBP_s, S.cap_z);
  const ApoB = val("ApoB"), nonHDL = val("nonHDL");
  const z_ApoB = has(ApoB)? z_worse(ApoB, N.ApoB_m, N.ApoB_s, S.cap_z) : null;
  const z_nHDL = (!has(ApoB) && has(nonHDL))? z_worse(nonHDL, N.nHDL_m, N.nHDL_s, S.cap_z) : null;
  const z_lip = z_ApoB!==null ? z_ApoB : (z_nHDL!==null ? z_nHDL : null);
  const z_A1c = has(val("A1c"))? z_worse(val("A1c"), N.A1c_m, N.A1c_s, S.cap_z) : null;
  const z_FPG = (!has(val("A1c")) && has(val("FPG")))? z_worse(val("FPG"), N.FPG_m, N.FPG_s, S.cap_z) : null;
  const z_gly = z_A1c!==null ? z_A1c : (z_FPG!==null ? z_FPG : null);
  const z_eGFR = z_better(val("eGFR"), N.eGFR_m, N.eGFR_s, S.cap_z);
  const z_CRP = has(val("CRP")) ? z_worse(val("CRP"), N.CRP_m, N.CRP_s, S.cap_z) : null;
  const WHtR = (has(val("waist")) && has(val("height")) && n(val("height"))>0) ? (n(val("waist"))/n(val("height"))) : null;
  const z_WHtR = (WHtR!==null) ? z_worse(WHtR, N.WHtR_m, N.WHtR_s, S.cap_z) : null;
  const z_RHR = z_worse(val("RHR"), N.RHR_m, N.RHR_s, S.cap_z);
  const z_VO2 = z_better(val("VO2"), N.VO2_m, N.VO2_s, S.cap_z);
  const z_Grip= z_better(val("grip"), N.Grip_m, N.Grip_s, S.cap_z);
  const z_smoke = (function(s){ if(s==="never") return 0; if(s==="former") return 0.25; if(s==="current") return 0.75; return 0; })(val("smoke"));

  const z_cardio = avg([z_SBP, z_lip, z_gly, z_eGFR, z_CRP]);
  const z_fit   = avg([z_VO2, z_RHR, z_Grip]);
  const z_anth  = z_WHtR;

  let sumW=0, score=0;
  if(z_cardio!==null){ score += W.cardiomet*z_cardio; sumW+=W.cardiomet; }
  if(z_fit!==null){ score += W.fitness*z_fit; sumW+=W.fitness; }
  if(z_anth!==null){ score += W.anthro*z_anth; sumW+=W.anthro; }
  if(z_smoke!==null){ score += W.smoke*z_smoke; sumW+=W.smoke; }
  const score_core = sumW>0 ? score/sumW : 0;
  const delta_core = S.k*score_core;
  const age_core = age + delta_core;

  function setProg(id, txtId, z, w){
    const p=document.getElementById(id), t=document.getElementById(txtId);
    if(z===null){ p.value=0; t.innerText="sin datos"; return; }
    const val=(z+S.cap_z)/(2*S.cap_z); p.value=val;
    const yrs=(w*z)*S.k; t.innerText=`z=${z.toFixed(2)} Â· contrib â‰ˆ ${yrs.toFixed(2)} aÃ±os`;
  }
  setProg("prog_cardiomet","txt_cardiomet",z_cardio??0,(z_cardio===null?0:W.cardiomet/sumW));
  setProg("prog_fitness","txt_fitness",z_fit??0,(z_fit===null?0:W.fitness/sumW));
  setProg("prog_anthro","txt_anthro",z_anth??0,(z_anth===null?0:W.anthro/sumW));
  setProg("prog_smoke","txt_smoke",z_smoke??0,(z_smoke===null?0:W.smoke/sumW));

  function sleepYears(){
    let pts=0;
    if(has(val("TST"))){ const h=n(val("TST")); if(h<6) pts+=0.5; else if(h>9) pts+=0.3; }
    if(has(val("SE")) && n(val("SE"))<85) pts+=0.3;
    if(has(val("AHI")) && n(val("AHI"))>=15) pts+=0.8;
    if(has(val("ODI")) && n(val("ODI"))>=5) pts+=0.6;
    if(val("STOP")==="si") pts+=0.4;
    return clamp(pts,-S.cap_sleep,S.cap_sleep);
  }
  function stressYears(){
    let pts=0;
    if(has(val("PSS")) && n(val("PSS"))>=20) pts+=0.5;
    if(has(val("PHQ")) && n(val("PHQ"))>=10) pts+=0.5;
    if(has(val("GAD")) && n(val("GAD"))>=10) pts+=0.5;
    return clamp(pts,-S.cap_stress,S.cap_stress);
  }
  function aeroYears(){
    let pts=0;
    if(has(val("MVPA"))){
      const m=n(val("MVPA"));
      if(m<75) pts+=0.35; else if(m>=150) pts-=0.15;
      if(m>=300) pts-=0.25;
    }
    return clamp(pts,-S.cap_aero,S.cap_aero);
  }
  function strengthYears(){
    let pts=0;
    if(has(val("STR"))){
      const d=n(val("STR"));
      if(d<1) pts+=0.35;
      else if(d===2) pts-=0.1;
      else if(d>=3) pts-=0.25;
    }
    return clamp(pts,-S.cap_strength,S.cap_strength);
  }
  function dietYears(){
    let pts=0;
    if(has(val("MedDiet"))){
      const md=n(val("MedDiet"));
      if(md>=10) pts-=0.5;
      else if(md<=5) pts+=0.5;
      else if(md>=7 && md<=9) pts+=0.0;
      else pts+=0.2;
    }
    if(has(val("Ultra"))){
      const u=n(val("Ultra"));
      if(u>=7) pts+=0.6;
      else if(u>=3) pts+=0.3;
    }
    if(has(val("AlcoholU"))){
      const a=n(val("AlcoholU"));
      const sex = val("sex");
      const modMax = (sex==="female")?7:14;
      if(a>modMax) pts+=0.5;
    }
    return clamp(pts,-S.cap_diet,S.cap_diet);
  }

  const yrs_sleep=sleepYears(), yrs_stress=stressYears(), yrs_aero=aeroYears(), yrs_strength=strengthYears(), yrs_diet=dietYears();
  const add_modules = yrs_sleep + yrs_stress + yrs_aero + yrs_strength + yrs_diet;
  const delta_ext = delta_core + add_modules;
  const age_ext = age + delta_ext;

  function setProgExt(id, txtId, yrs, cap){
    const p=document.getElementById(id), t=document.getElementById(txtId);
    const val=(yrs+cap)/(2*cap); p.value=val;
    t.innerText=`impacto â‰ˆ ${yrs.toFixed(2)} aÃ±os (tope Â±${cap})`;
  }
  setProgExt("prog_sleep","txt_sleep",yrs_sleep, S.cap_sleep);
  setProgExt("prog_stress","txt_stress",yrs_stress, S.cap_stress);
  setProgExt("prog_aero","txt_aero",yrs_aero, S.cap_aero);
  setProgExt("prog_strength","txt_strength",yrs_strength, S.cap_strength);
  setProgExt("prog_diet","txt_diet",yrs_diet, S.cap_diet);

  // KPIs y CIs
  document.getElementById("age_core").innerText = age_core.toFixed(1)+" aÃ±os";
  document.getElementById("age_ext").innerText  = age_ext.toFixed(1)+" aÃ±os";
  document.getElementById("delta_core").innerText = (delta_core>=0?"+":"") + delta_core.toFixed(2)+" a";
  document.getElementById("delta_modules").innerText = (add_modules>=0?"+":"") + add_modules.toFixed(2)+" a";
  document.getElementById("age_core_ci").innerText = "Â± " + scalars().unc_core.toFixed(1) + " aÃ±os";
  document.getElementById("age_ext_ci").innerText  = "Â± " + (scalars().unc_core + scalars().unc_ext).toFixed(1) + " aÃ±os";

  // NÃºcleo: color + halo + sonido opcional
  const bubble = document.getElementById("bubble");
  const halo = document.getElementById("halo");
  const bubbleNumber = document.getElementById("bubbleNumber");
  const diff = age_ext - age;
  let cls="good", caption="";
  if(diff <= -0.5){ cls="good"; caption = "Tu cuerpo se siente mÃ¡s joven"; }
  else if(diff > -0.5 && diff <= 3){ cls="warn"; caption = "Ligero exceso de edad-salud"; }
  else { cls="bad"; caption = "Envejecimiento acelerado: revisar palancas"; }
  bubble.className = "bubble " + cls;
  halo.className = "halo " + cls;
  bubbleNumber.textContent = age_ext.toFixed(1);
  document.getElementById("bubbleCaption").textContent = caption;

  // Sonido opcional (suave) si resultado es Ã³ptimo (< -1 aÃ±o)
  if(document.getElementById("soundOn").checked && diff <= -1){
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = "sine";
      o.frequency.setValueAtTime(520, ctx.currentTime);
      g.gain.setValueAtTime(0.0001, ctx.currentTime);
      g.gain.linearRampToValueAtTime(0.06, ctx.currentTime + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
      o.connect(g).connect(ctx.destination);
      o.start();
      o.stop(ctx.currentTime + 0.26);
    }catch(e){ /* silencio si navegador bloquea */ }
  }
}

function saveJSON(){
  const ids=["sex","age","SBP","ApoB","nonHDL","A1c","FPG","eGFR","CRP","waist","height","RHR","VO2","grip","smoke","TST","SE","AHI","ODI","STOP","PSS","PHQ","GAD","MVPA","STR","MedDiet","Ultra","AlcoholU"];
  const obj={}; ids.forEach(id=>obj[id]=val(id));
  const blob = new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="thymeage_v2_2_inputs.json"; a.click();
}
function loadJSON(){
  const inp=document.createElement("input"); inp.type="file"; inp.accept=".json,application/json";
  inp.onchange = e=>{ const file=e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ev=>{ try{ const data=JSON.parse(ev.target.result); Object.keys(data).forEach(k=>{ const el=document.getElementById(k); if(el) el.value=data[k]; }); computeAll(); } catch(err){ alert("Archivo JSON invÃ¡lido"); } };
    reader.readAsText(file);
  };
  inp.click();
}

window.addEventListener("DOMContentLoaded", ()=>{
  document.getElementById("sex").value="female";
  document.getElementById("age").value=39;
  document.getElementById("SBP").value=118;
  document.getElementById("nonHDL").value=130;
  document.getElementById("A1c").value=5.2;
  document.getElementById("eGFR").value=110;
  document.getElementById("CRP").value=1.2;
  document.getElementById("waist").value=72;
  document.getElementById("height").value=165;
  document.getElementById("RHR").value=64;
  document.getElementById("VO2").value=36;
  document.getElementById("grip").value=28;
  document.getElementById("smoke").value="never";
  document.getElementById("TST").value=7.0;
  document.getElementById("SE").value=88;
  document.getElementById("STOP").value="no";
  document.getElementById("PSS").value=14;
  document.getElementById("PHQ").value=3;
  document.getElementById("GAD").value=3;
  document.getElementById("MVPA").value=150;
  document.getElementById("STR").value=2;
  document.getElementById("MedDiet").value=7;
  document.getElementById("Ultra").value=3;
  document.getElementById("AlcoholU").value=2;
  computeAll();
});
</script>
</body>
</html>
